{% extends "base.html" %}
{% block content %}
<div class="app-container">
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-logo">üí¨</div>
            <h1 class="sidebar-title">Chattrix</h1>
            <p class="sidebar-subtitle">Private Chat</p>
        </div>
        
        <nav class="sidebar-nav">
            <a href="{{ url_for('index') }}" class="nav-item">
                <span class="nav-icon">üè†</span> Public Chat
            </a>
            <a href="{{ url_for('conversations') }}" class="nav-item">
                <span class="nav-icon">üí¨</span> Private Chats
            </a>
            <a href="{{ url_for('user_list') }}" class="nav-item">
                <span class="nav-icon">üë•</span> All Users
            </a>
            <a href="{{ url_for('profile') }}" class="nav-item">
                <span class="nav-icon">üë§</span> Profile
            </a>
            {% if current_user.is_admin %}
                <a href="/admin" class="nav-item">
                    <span class="nav-icon">‚öôÔ∏è</span> Admin
                </a>
            {% endif %}
        </nav>
        
        <div class="online-users">
            <div class="online-users-title">Chat with</div>
            <div class="private-chat-user">
                <div class="conversation-avatar" style="width: 40px; height: 40px; font-size: 1rem;">
                    {{ other_user.display_name[0].upper() if other_user.display_name else other_user.username[0].upper() }}
                </div>
                <div style="margin-left: 0.75rem;">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.875rem;">
                        {{ other_user.display_name or other_user.username }}
                    </div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary);">
                        @{{ other_user.username }}
                    </div>
                </div>
            </div>
        </div>
        
        <button class="btn btn-danger btn-block" onclick="window.location.href='/logout'">
            Logout
        </button>
        <button id="darkModeToggle" class="dark-mode-toggle">üåô</button>
    </div>

    <div class="main-content">
        <div class="main-header">
            <h1 class="main-title">
                üí¨ {{ other_user.display_name or other_user.username }}
            </h1>
        </div>
        
        <div id="privateMessages" class="messages-container">
            <!-- Load existing messages -->
            {% for message in messages %}
                <div class="message {% if message.sender_id == current_user.id %}private{% endif %}">
                    <div class="message-avatar">
                        {% if message.sender_id == current_user.id %}
                            {{ current_user.display_name[0].upper() if current_user.display_name else current_user.username[0].upper() }}
                        {% else %}
                            {{ other_user.display_name[0].upper() if other_user.display_name else other_user.username[0].upper() }}
                        {% endif %}
                    </div>
                    <div class="message-content">
                        <div class="message-header">
                            <span class="message-author">
                                {% if message.sender_id == current_user.id %}
                                    {{ current_user.display_name or current_user.username }}
                                {% else %}
                                    {{ other_user.display_name or other_user.username }}
                                {% endif %}
                            </span>
                            <span class="message-time">{{ message.timestamp.strftime('%H:%M') }}</span>
                        </div>
                        <div class="message-text">{{ message.text }}</div>
                    </div>
                </div>
            {% endfor %}
        </div>
        
        <!-- Typing indicator for private chat -->
        <div id="typingIndicator" style="display: none;"></div>
        
        <div class="message-form-container">
            <form id="privateMessageForm" class="message-form">
                <label for="private-file-input" class="file-upload-btn">üìé</label>
                <input type="file" id="private-file-input" accept="image/*,.pdf,.txt,.docx,.mp4" style="display: none;">
                <input type="text" id="privateMsgInput" class="message-input" placeholder="Type your private message..." required>
                <input type="hidden" id="recipientId" value="{{ other_user.id }}">
                <button type="submit" class="send-btn">Send</button>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
<script>
// Initialize Socket.IO
const socket = io();
const currentUserId = {{ current_user.id }};
const otherUserId = {{ other_user.id }};
const currentUserName = "{{ current_user.display_name or current_user.username }}";
const otherUserName = "{{ other_user.display_name or other_user.username }}";

// Also set global variables for the main script
window.currentUserId = {{ current_user.id }};
window.isAdmin = {{ 'true' if current_user.is_admin else 'false' }};

// File upload state for private chat
let selectedPrivateFile = null;

// Join private room when connected
socket.on('connect', function() {
    console.log('Connected to server');
    socket.emit('join_private_room', {
        'user1_id': currentUserId,
        'user2_id': otherUserId
    });
    
    // Set user location
    socket.emit('user_location', { location: 'private_chat' });
});

// Handle private message form submission
document.getElementById('privateMessageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const messageInput = document.getElementById('privateMsgInput');
    const message = messageInput.value.trim();
    
    // Check if there's a file selected
    if (selectedPrivateFile) {
        // Upload file
        uploadPrivateFile(selectedPrivateFile);
    } else if (message) {
        // Send text message
        console.log('Sending private message:', message);
        
        // Send via Socket.IO
        socket.emit('private_message', {
            'recipient_id': otherUserId,
            'message': message
        });
        
        messageInput.value = '';
    }
});

// Handle receiving private messages - listen for the correct event
socket.on('receive_private_message', function(data) {
    console.log('Received private message:', data);
    displayPrivateMessage(data);
});

// Display private message function
function displayPrivateMessage(data) {
    const messagesContainer = document.getElementById('privateMessages');
    const messageDiv = document.createElement('div');
    const isOwnMessage = data.sender_id === currentUserId;
    
    messageDiv.className = `message ${isOwnMessage ? 'private' : ''}`;
    
    const avatarLetter = isOwnMessage ? 
        "{{ current_user.display_name[0].upper() if current_user.display_name else current_user.username[0].upper() }}" :
        "{{ other_user.display_name[0].upper() if other_user.display_name else other_user.username[0].upper() }}";
    
    const authorName = isOwnMessage ? currentUserName : otherUserName;
    
    messageDiv.innerHTML = `
        <div class="message-avatar">${avatarLetter}</div>
        <div class="message-content">
            <div class="message-header">
                <span class="message-author">${authorName}</span>
                <span class="message-time">${new Date(data.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</span>
            </div>
            <div class="message-text">${processFileMessage(data.message || data.text)}</div>
        </div>
    `;
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Auto-scroll to bottom on page load
document.addEventListener('DOMContentLoaded', function() {
    const messagesContainer = document.getElementById('privateMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    
    // Initialize file upload for private chat
    initializePrivateFileUpload();
    
    // Dark mode toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    
    // Load saved theme
    const savedTheme = localStorage.getItem('darkMode');
    if (savedTheme === 'true') {
        document.body.classList.add('dark-mode');
        if (darkModeToggle) darkModeToggle.textContent = '‚òÄÔ∏è';
    }
    
    // Toggle dark mode
    if (darkModeToggle) {
        darkModeToggle.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            localStorage.setItem('darkMode', isDark);
            darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        });
    }
});

// Handle Enter key
document.getElementById('privateMsgInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        document.getElementById('privateMessageForm').dispatchEvent(new Event('submit'));
    }
});

// Debug logging
socket.on('connect', () => console.log('Socket connected'));
socket.on('disconnect', () => console.log('Socket disconnected'));
socket.on('error', (error) => console.error('Socket error:', error));

// Initialize private file upload functionality
function initializePrivateFileUpload() {
    const privateFileInput = document.getElementById('private-file-input');
    if (privateFileInput) {
        privateFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedPrivateFile = file;
            showFilePreview(file, 'private');
        });
    }
}

// Show file preview function (simplified for private chat)
function showFilePreview(file, chatType) {
    const isImage = file.type.startsWith('image/');
    const messageForm = document.getElementById('privateMessageForm');
    
    if (!messageForm) return;
    
    // Remove existing preview
    const existingPreview = messageForm.querySelector('.file-preview');
    if (existingPreview) {
        existingPreview.remove();
    }
    
    // Create preview container
    const previewContainer = document.createElement('div');
    previewContainer.className = 'file-preview';
    
    if (isImage) {
        // Create image preview
        const reader = new FileReader();
        reader.onload = function(e) {
            previewContainer.innerHTML = `
                <div class="file-preview-content">
                    <div class="file-preview-image-container">
                        <img src="${e.target.result}" class="file-preview-image" alt="${file.name}">
                    </div>
                    <div class="file-preview-info">
                        <span class="file-preview-name">${file.name}</span>
                        <span class="file-preview-size">${formatFileSize(file.size)}</span>
                    </div>
                    <button type="button" class="file-preview-remove" onclick="removeFilePreview('private')">√ó</button>
                </div>
            `;
        };
        reader.readAsDataURL(file);
    } else {
        // Create file preview for non-images
        const fileIcon = getFileIcon(file.name.split('.').pop().toLowerCase());
        previewContainer.innerHTML = `
            <div class="file-preview-content">
                <div class="file-preview-file">
                    <span class="file-preview-icon">${fileIcon}</span>
                    <div class="file-preview-info">
                        <span class="file-preview-name">${file.name}</span>
                        <span class="file-preview-size">${formatFileSize(file.size)}</span>
                    </div>
                </div>
                <button type="button" class="file-preview-remove" onclick="removeFilePreview('private')">√ó</button>
            </div>
        `;
    }
    
    // Insert preview before the input row
    const inputRow = messageForm.querySelector('.message-input') || messageForm.querySelector('input[type="text"]');
    if (inputRow) {
        inputRow.parentNode.insertBefore(previewContainer, inputRow);
    }
}

// Remove file preview
function removeFilePreview(chatType) {
    selectedPrivateFile = null;
    document.getElementById('private-file-input').value = '';
    const preview = document.querySelector('#privateMessageForm .file-preview');
    if (preview) preview.remove();
}

// Format file size
function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Upload private file
function uploadPrivateFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('recipient_id', otherUserId);
    
    // Show upload indicator
    showUploadProgress('Uploading file...');
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideUploadProgress();
        if (data.success) {
            console.log('Private file uploaded successfully:', data.filename);
            
            // Clear the file selection and preview
            removeFilePreview('private');
        } else {
            showErrorMessage('Upload failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        hideUploadProgress();
        console.error('Upload error:', error);
        showErrorMessage('Upload failed: ' + error.message);
    });
}

// Handle private file upload
function handlePrivateFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const formData = new FormData();
    formData.append('file', file);
    formData.append('recipient_id', otherUserId);
    
    // Show upload indicator
    showUploadProgress('Uploading file...');
    
    fetch('/upload', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideUploadProgress();
        if (data.success) {
            console.log('Private file uploaded successfully:', data.filename);
            // The server will emit the message via SocketIO automatically
        } else {
            showErrorMessage('Upload failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        hideUploadProgress();
        console.error('Upload error:', error);
        showErrorMessage('Upload failed: ' + error.message);
    })
    .finally(() => {
        // Clear the file input
        event.target.value = '';
    });
}

// Process file messages for display in private chat
function processFileMessage(text) {
    // Check if this is a file message with format [FILE:filename:original_filename]
    const fileMatch = text.match(/^\[FILE:([^:]+):(.+)\]$/);
    if (fileMatch) {
        const [, filename, originalFilename] = fileMatch;
        const fileExtension = originalFilename.toLowerCase().split('.').pop();
        
        // Determine if it's an image
        const imageExtensions = ['png', 'jpg', 'jpeg', 'gif'];
        const isImage = imageExtensions.includes(fileExtension);
        
        if (isImage) {
            return `
                <div class="file-message image-message">
                    <img src="/static/uploads/${filename}" alt="${originalFilename}" class="uploaded-image" 
                         onclick="openImageModal(this.src, '${originalFilename}')">
                    <div class="file-info">
                        <span class="file-icon">üñºÔ∏è</span>
                        <span class="file-name">${originalFilename}</span>
                    </div>
                </div>
            `;
        } else {
            // Non-image file
            const fileIcon = getFileIcon(fileExtension);
            return `
                <div class="file-message">
                    <a href="/static/uploads/${filename}" target="_blank" download="${originalFilename}" class="file-link">
                        <span class="file-icon">${fileIcon}</span>
                        <span class="file-name">${originalFilename}</span>
                        <span class="file-action">üì• Download</span>
                    </a>
                </div>
            `;
        }
    }
    
    return text; // Return original text if not a file message
}

// Get appropriate icon for file type
function getFileIcon(extension) {
    const iconMap = {
        'pdf': 'üìÑ',
        'txt': 'üìù',
        'docx': 'üìÑ',
        'doc': 'üìÑ',
        'mp4': 'üé•',
        'avi': 'üé•',
        'mov': 'üé•',
        'zip': 'üì¶',
        'rar': 'üì¶'
    };
    
    return iconMap[extension] || 'üìé';
}

// Show upload progress indicator
function showUploadProgress(message) {
    let indicator = document.getElementById('upload-indicator');
    if (!indicator) {
        indicator = document.createElement('div');
        indicator.id = 'upload-indicator';
        indicator.className = 'upload-indicator';
        indicator.innerHTML = `
            <div class="upload-content">
                <div class="upload-spinner"></div>
                <span class="upload-text">${message}</span>
            </div>
        `;
        document.body.appendChild(indicator);
    } else {
        indicator.querySelector('.upload-text').textContent = message;
    }
    indicator.style.display = 'flex';
}

// Hide upload progress indicator
function hideUploadProgress() {
    const indicator = document.getElementById('upload-indicator');
    if (indicator) {
        indicator.style.display = 'none';
    }
}

// Show error message
function showErrorMessage(message) {
    let errorDiv = document.getElementById('error-message');
    if (!errorDiv) {
        errorDiv = document.createElement('div');
        errorDiv.id = 'error-message';
        errorDiv.className = 'error-message';
        document.body.appendChild(errorDiv);
    }
    
    errorDiv.textContent = message;
    errorDiv.style.display = 'block';
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        errorDiv.style.display = 'none';
    }, 5000);
}

// Open image in modal
function openImageModal(src, filename) {
    let modal = document.getElementById('image-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'image-modal';
        modal.className = 'image-modal';
        modal.innerHTML = `
            <div class="modal-content">
                <span class="modal-close">&times;</span>
                <img class="modal-image" src="" alt="">
                <div class="modal-caption"></div>
            </div>
        `;
        document.body.appendChild(modal);
        
        // Close modal on click
        modal.querySelector('.modal-close').onclick = () => modal.style.display = 'none';
        modal.onclick = (e) => {
            if (e.target === modal) modal.style.display = 'none';
        };
    }
    
    // Set image and show modal
    modal.querySelector('.modal-image').src = src;
    modal.querySelector('.modal-caption').textContent = filename;
    modal.style.display = 'block';
}
</script>
{% endblock %}